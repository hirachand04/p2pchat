<!DOCTYPE html>
<html>
<head>
  <title>Microphone Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
    button { padding: 15px 30px; font-size: 16px; cursor: pointer; margin: 10px; }
    #log { background: #16213e; padding: 15px; border-radius: 8px; margin-top: 20px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Microphone Test</h1>
  <p>Click the button below to test microphone access.</p>
  
  <button onclick="testMicrophone()">Test Microphone</button>
  <button onclick="checkPermission()">Check Permission State</button>
  <button onclick="clearLog()">Clear Log</button>
  
  <div id="log"></div>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<span class="${type}">[${time}] ${message}</span>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function checkPermission() {
      log('Checking permission state...', 'info');
      
      if (!navigator.permissions) {
        log('navigator.permissions not available', 'error');
        return;
      }

      try {
        const result = await navigator.permissions.query({ name: 'microphone' });
        log(`Permission state: ${result.state}`, result.state === 'granted' ? 'success' : 'error');
        
        result.onchange = () => {
          log(`Permission changed to: ${result.state}`, 'info');
        };
      } catch (err) {
        log(`Error querying permission: ${err.name} - ${err.message}`, 'error');
      }
    }

    async function testMicrophone() {
      log('=== Starting Microphone Test ===', 'info');
      
      // Check if mediaDevices exists
      if (!navigator.mediaDevices) {
        log('ERROR: navigator.mediaDevices is not available', 'error');
        log('This usually means:', 'error');
        log('  - You are not on HTTPS (required for getUserMedia)', 'error');
        log('  - Your browser is outdated', 'error');
        return;
      }
      log('âœ“ navigator.mediaDevices available', 'success');

      // Check if getUserMedia exists
      if (!navigator.mediaDevices.getUserMedia) {
        log('ERROR: getUserMedia is not available', 'error');
        return;
      }
      log('âœ“ getUserMedia available', 'success');

      // Check secure context
      log(`isSecureContext: ${window.isSecureContext}`, window.isSecureContext ? 'success' : 'error');
      log(`Protocol: ${window.location.protocol}`, 'info');
      log(`Host: ${window.location.host}`, 'info');

      // List available devices first
      try {
        log('Enumerating devices...', 'info');
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioInputs = devices.filter(d => d.kind === 'audioinput');
        log(`Found ${audioInputs.length} audio input device(s)`, audioInputs.length > 0 ? 'success' : 'error');
        
        audioInputs.forEach((device, i) => {
          log(`  ${i + 1}. ${device.label || '(no label - permission needed)'}`, 'info');
        });
      } catch (err) {
        log(`Error enumerating devices: ${err.message}`, 'error');
      }

      // Try to get microphone access
      log('Requesting microphone access...', 'info');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log('âœ“ SUCCESS! Microphone access granted', 'success');
        log(`Stream ID: ${stream.id}`, 'success');
        
        const tracks = stream.getAudioTracks();
        log(`Audio tracks: ${tracks.length}`, 'success');
        tracks.forEach((track, i) => {
          log(`  Track ${i + 1}: ${track.label}, state: ${track.readyState}`, 'success');
        });

        // Test MediaRecorder
        log('Testing MediaRecorder...', 'info');
        try {
          const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/ogg', ''];
          let supportedType = '';
          for (const type of types) {
            if (type === '' || MediaRecorder.isTypeSupported(type)) {
              supportedType = type || '(default)';
              break;
            }
          }
          log(`âœ“ Supported mimeType: ${supportedType}`, 'success');

          const recorder = new MediaRecorder(stream, supportedType && supportedType !== '(default)' ? { mimeType: supportedType.replace('(default)', '') } : undefined);
          log(`âœ“ MediaRecorder created, state: ${recorder.state}`, 'success');
        } catch (recErr) {
          log(`MediaRecorder error: ${recErr.message}`, 'error');
        }

        // Clean up
        stream.getTracks().forEach(track => track.stop());
        log('Stream stopped (cleanup)', 'info');
        log('=== Test Complete - SUCCESS ===', 'success');

      } catch (err) {
        log(`ERROR: ${err.name}`, 'error');
        log(`Message: ${err.message}`, 'error');
        
        if (err.name === 'NotAllowedError') {
          log('', 'info');
          log('NotAllowedError means:', 'error');
          log('  - User denied permission, OR', 'error');
          log('  - Permission was previously denied and cached, OR', 'error');
          log('  - Site settings block microphone', 'error');
          log('', 'info');
          log('To fix:', 'info');
          log('  1. Click the lock icon in the address bar', 'info');
          log('  2. Find Microphone settings', 'info');
          log('  3. Change from Block to Allow', 'info');
          log('  4. Refresh the page', 'info');
        } else if (err.name === 'NotFoundError') {
          log('No microphone device found', 'error');
        } else if (err.name === 'NotReadableError') {
          log('Microphone is in use by another app', 'error');
        }
        
        log('=== Test Complete - FAILED ===', 'error');
      }
    }

    // Auto-run on load
    log('Microphone Test Page Loaded', 'info');
    log(`URL: ${window.location.href}`, 'info');
    checkPermission();
  </script>
</body>
</html>
